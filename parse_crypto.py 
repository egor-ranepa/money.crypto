import requests
from bs4 import BeautifulSoup

def get_tokens(count=10):
    """Парсит токены с Etherscan и возвращает отсортированный список"""
    url = "https://etherscan.io/tokens"
    
    # Заголовки для имитации браузера
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
        'Accept-Encoding': 'gzip, deflate',
        'Connection': 'keep-alive',
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'html.parser')
        tokens = []
        
        # Находим таблицу с токенами
        table = soup.find('table')
        if not table:
            print("Таблица не найдена")
            return []
        
        # Находим все строки таблицы с токенами (пропускаем заголовок)
        rows = table.find_all('tr')[1:51]  # берем первые 50 токенов
        
        for row in rows:
            cells = row.find_all('td')
            if len(cells) < 4:
                continue
            
            # Извлекаем название и ссылку
            token_cell = cells[1]
            link = token_cell.find('a')
            if not link:
                continue
                
            token_text = link.get_text(strip=True)
            token_url = "https://etherscan.io" + link.get('href')
            
            # Разделяем название и тикер
            if '(' in token_text and ')' in token_text:
                name = token_text.split('(')[0].strip()
                ticker = token_text.split('(')[1].replace(')', '').strip()
            else:
                name = token_text
                ticker = ""
            
            # Извлекаем цену (третья колонка)
            price_cell = cells[3]
            price_text = price_cell.get_text(strip=True)
            
            # Очищаем цену от символов
            price_clean = ""
            for char in price_text:
                if char.isdigit() or char == '.':
                    price_clean += char
                elif char == '$':
                    continue
                else:
                    break  # останавливаемся на первом нечисловом символе (кроме $ и .)
            
            try:
                price = float(price_clean) if price_clean else 0.0
            except ValueError:
                price = 0.0
            
            tokens.append({
                'name': name,
                'ticker': ticker,
                'price': price,
                'url': token_url
            })
        
        # Сортируем по убыванию цены и возвращаем нужное количество
        sorted_tokens = sorted(tokens, key=lambda x: x['price'], reverse=True)
        return sorted_tokens[:count]
        
    except requests.RequestException as e:
        print(f"Ошибка при запросе: {e}")
        return []
    except Exception as e:
        print(f"Неожиданная ошибка: {e}")
        return []

def main():
    print("Парсер криптовалют с Etherscan")
    print("=" * 50)
    
    try:
        count = int(input("Сколько токенов показать? (по умолчанию 10): ") or "10")
        if count <= 0:
            count = 10
    except ValueError:
        count = 10
        print("Используется значение по умолчанию: 10")
    
    print(f"\nПолучаем данные о {count} самых дорогих токенах...")
    tokens = get_tokens(count)
    
    if not tokens:
        print("Не удалось получить данные о токенах")
        return
    
    print(f"\nТоп {len(tokens)} самых дорогих токенов:")
    print("=" * 70)
    print(f"{'№':<3} {'Название':<25} {'Тикер':<10} {'Цена (USD)':<15}")
    print("-" * 70)
    
    for i, token in enumerate(tokens, 1):
        name = token['name'][:23] + "..." if len(token['name']) > 23 else token['name']
        ticker = token['ticker'][:8] if token['ticker'] else "N/A"
        price = f"${token['price']:,.2f}"
        
        print(f"{i:<3} {name:<25} {ticker:<10} {price:<15}")

if __name__ == "__main__":
    main()